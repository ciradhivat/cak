<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4a90e2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Thai Tokenizer App</title>
    
    <!-- PWA Manifest (Data URI for Single File Demo) -->
    <!-- ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô <head> ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå HTML -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            --primary: #4a90e2;
            --primary-dark: #357abd;
            --success: #34c759; /* iOS Green */
            --warning: #ffcc00;
            --danger: #ff3b30; /* iOS Red */
            --bg-app: #f2f2f7;  /* iOS System Gray */
            --bg-card: #ffffff;
            --text-main: #1c1c1e;
            --text-sec: #8e8e93;
            --radius: 16px;
            --shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Sarabun', 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 40px; /* Space for scroll */
        }

        /* --- Header (App Bar) --- */
        header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .header-actions button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        /* --- Layout --- */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: none;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Forms & Inputs --- */
        input[type="text"], textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            font-size: 16px; /* Prevent Zoom on iOS */
            background: #f9f9f9;
            transition: all 0.2s;
            font-family: inherit;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.15);
        }

        textarea { height: 120px; resize: none; }

        /* --- Search Box --- */
        .search-wrapper {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-status {
            font-size: 0.9rem;
            margin-top: 8px;
            min-height: 20px;
            font-weight: 500;
        }
        .text-success { color: var(--success); }
        .text-primary { color: var(--primary); }
        .text-danger { color: var(--danger); }

        /* --- Buttons --- */
        .btn {
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
            width: 100%; /* Mobile First: Full Width */
        }
        
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { background-color: var(--primary); color: white; box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-warning { background-color: var(--warning); color: #333; }
        .btn-danger { background-color: #fff; color: var(--danger); border: 1px solid var(--danger); padding: 8px 15px; font-size: 0.9rem;}
        
        .btn-row {
            display: flex;
            gap: 10px;
        }
        
        /* --- Tag List --- */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            max-height: 220px;
            overflow-y: auto;
            padding: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .tag {
            background-color: #eef1f5;
            color: var(--text-main);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            border: 1px solid transparent;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Animation Highligth */
        .tag.highlight {
            background-color: var(--warning) !important;
            color: #000 !important;
            transform: scale(1.15);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .tag .remove {
            margin-left: 8px;
            color: var(--text-sec);
            font-weight: bold;
            padding: 2px 6px;
        }

        /* --- Result Token --- */
        #output {
            line-height: 1.8;
            font-size: 1.1rem;
            min-height: 80px;
            background: #fafafa;
            border-radius: 12px;
            padding: 15px;
            border: 1px dashed #ccc;
        }
        
        .token {
            display: inline-block;
            margin: 2px;
            padding: 2px 6px;
            background: #eef6ff;
            color: var(--primary-dark);
            border-radius: 6px;
            border-bottom: 2px solid #dae8f9;
        }
        .token.unknown {
            background: #fff5f5;
            color: var(--danger);
            border-bottom-color: #ffe0e0;
            cursor: pointer;
        }

        /* --- Floating Action Button (Optional for Add) or Bottom Bar? 
           Let's keep it simple with clear sections --- */

        /* Responsive Desktop */
        @media (min-width: 768px) {
            .btn { width: auto; }
            .container { padding-top: 30px; }
            .card { padding: 30px; }
        }
    </style>
</head>
<body>

<!-- Header (Sticky) -->
<header>
    <h1>‚úÇÔ∏è Thai Tokenizer</h1>
    <div class="header-actions">
        <!-- Hidden File Input -->
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJson(this)">
        <button onclick="document.getElementById('importFile').click()">Import</button>
        <button onclick="exportJson()">Backup</button>
    </div>
</header>

<div class="container">

    <!-- Card 1: Tokenizer (Action First) -->
    <div class="card">
        <div class="card-title">
            <span>üîé ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥</span>
            <button id="dlBtn" class="btn btn-warning" onclick="saveResultText()" style="display:none; padding: 6px 12px; font-size: 0.85rem;">
                üì• .txt
            </button>
        </div>
        
        <textarea id="inputText" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
        <button class="btn btn-primary" onclick="processText()">‚ö° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥ (Tokenize)</button>
        
        <div style="margin-top: 20px;">
            <label style="font-size: 0.9rem; color: var(--text-sec); margin-bottom: 5px; display:block;">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</label>
            <div id="output">
                <span style="color: #ccc;">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</span>
            </div>
        </div>
    </div>

    <!-- Card 2: Dictionary Management -->
    <div class="card">
        <div class="card-title">
            <span>üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå <span id="countDisplay" style="font-size: 0.8rem; font-weight: normal; color: #888;">(0)</span></span>
            <button class="btn btn-danger" onclick="resetDictionary()">Reset</button>
        </div>

        <!-- Search -->
        <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö..." onkeyup="checkWord()">
            <div id="searchStatus" class="search-status"></div>
        </div>

        <!-- Add Word -->
        <div class="btn-row">
            <input type="text" id="newWordInput" placeholder="‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡πÉ‡∏´‡∏°‡πà..." onkeypress="handleEnter(event)">
            <button class="btn btn-success" onclick="addNewWord()" style="width: auto; min-width: 80px;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>

        <!-- List -->
        <div id="userWordList" class="tag-list">
            <!-- Tags rendered via JS -->
        </div>
    </div>

</div>

<script>
    /* --- LOGIC: ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ 100% --- */

    const defaultWordsList = [
        "‡∏û‡πà‡∏≠", "‡πÅ‡∏°‡πà", "‡∏õ‡∏π‡πà", "‡∏¢‡πà‡∏≤", "‡∏ï‡∏≤", "‡∏¢‡∏≤‡∏¢", "‡∏•‡∏∏‡∏á", "‡∏õ‡πâ‡∏≤", "‡∏ô‡πâ‡∏≤", "‡∏≠‡∏≤", 
        "‡∏Å‡∏¥‡∏ô", "‡πÄ‡∏î‡∏¥‡∏ô", "‡∏ô‡∏±‡πà‡∏á", "‡∏ô‡∏≠‡∏ô", "‡πÑ‡∏õ", "‡∏°‡∏≤", "‡∏´‡∏≤", "‡∏™‡∏π‡πà", "‡∏£‡∏±‡∏Å", "‡∏ä‡∏≠‡∏ö",
        "‡∏Ñ‡∏ô", "‡∏™‡∏±‡∏ï‡∏ß‡πå", "‡∏™‡∏¥‡πà‡∏á", "‡∏Ç‡∏≠‡∏á", "‡πÇ‡∏£‡∏á", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏á‡∏≤‡∏ô", "‡∏Å‡∏≤‡∏£", "‡∏°‡∏µ", "‡πÉ‡∏à",
        "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ", "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì", "‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏Ñ‡πà‡∏∞"
    ];

    let defaultWordsSet = new Set(defaultWordsList);
    let userWords = new Set();
    let allWords = new Set();
    let currentTokens = [];

    // Init
    function init() {
        const savedData = localStorage.getItem('thaiDictPWA_v8');
        if (savedData) {
            try {
                const arr = JSON.parse(savedData);
                arr.forEach(w => userWords.add(w));
            } catch(e) {}
        }
        refreshAllWords();
        renderUserTags();
    }

    function refreshAllWords() {
        allWords = new Set([...defaultWordsSet, ...userWords]);
        document.getElementById('countDisplay').innerText = `(${userWords.size} ‡∏Ñ‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á)`;
    }

    // --- Search & Highlight ---
    function checkWord() {
        const input = document.getElementById('searchInput');
        const statusDiv = document.getElementById('searchStatus');
        const word = input.value.trim();

        if (!word) {
            statusDiv.innerHTML = "";
            return;
        }

        if (userWords.has(word)) {
            statusDiv.innerHTML = `<span class="text-success">‚úÖ ‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>`;
            scrollToWord(word);
        } else if (defaultWordsSet.has(word)) {
            statusDiv.innerHTML = `<span class="text-primary">üîπ ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö</span>`;
        } else {
            statusDiv.innerHTML = `<span class="text-danger">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</span>`;
        }
    }

    function scrollToWord(word) {
        const targetTag = document.querySelector(`.tag[data-word="${word}"]`);
        if (targetTag) {
            targetTag.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetTag.classList.add('highlight');
            setTimeout(() => targetTag.classList.remove('highlight'), 1500);
        }
    }

    // --- Dict Management ---
    function addNewWord() {
        const input = document.getElementById('newWordInput');
        const word = input.value.trim();
        if (!word) return;

        if (allWords.has(word)) {
            alert("‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
            if(userWords.has(word)) scrollToWord(word);
            return;
        }

        userWords.add(word);
        saveAndRefresh();
        input.value = '';
        if(document.getElementById('searchInput').value === word) checkWord();
        setTimeout(() => scrollToWord(word), 100);
    }

    function removeWord(word) {
        if(confirm(`‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "${word}"?`)){
            userWords.delete(word);
            saveAndRefresh();
            if(document.getElementById('searchInput').value === word) checkWord();
        }
    }

    function saveAndRefresh() {
        localStorage.setItem('thaiDictPWA_v8', JSON.stringify([...userWords]));
        refreshAllWords();
        renderUserTags();
        if(document.getElementById('inputText').value) processText();
    }

    function renderUserTags() {
        const container = document.getElementById('userWordList');
        container.innerHTML = '';
        if (userWords.size === 0) {
            container.innerHTML = '<div style="width:100%; text-align:center; color:#ccc; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            return;
        }
        
        const sorted = [...userWords].sort((a,b) => a.localeCompare(b, 'th'));
        const fragment = document.createDocumentFragment();

        sorted.forEach(word => {
            const div = document.createElement('div');
            div.className = 'tag';
            div.setAttribute('data-word', word);
            div.innerHTML = `
                ${word} 
                <span class="remove" onclick="removeWord('${word}')">√ó</span>
            `;
            fragment.appendChild(div);
        });
        container.appendChild(fragment);
    }

    // --- Import/Export ---
    function exportJson() {
        if (userWords.size === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Backup"); return; }
        const data = { type: "thai-tokenizer-pwa", date: new Date(), words: [...userWords] };
        downloadFile("thai_dict_backup.json", JSON.stringify(data, null, 2), "application/json");
    }

    function importJson(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                const list = Array.isArray(json) ? json : (json.words || []);
                let count = 0;
                list.forEach(w => {
                    if(typeof w === 'string' && w.trim() && !allWords.has(w.trim())) {
                        userWords.add(w.trim());
                        count++;
                    }
                });
                if(count > 0) { saveAndRefresh(); alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏Ñ‡∏≥`); }
                else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡πÉ‡∏´‡∏°‡πà"); }
            } catch(err) { alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
            input.value = '';
        };
        reader.readAsText(file);
    }

    // --- Tokenizer ---
    function processText() {
        const text = document.getElementById('inputText').value.trim();
        const out = document.getElementById('output');
        const btn = document.getElementById('dlBtn');

        if(!text) {
            out.innerHTML = '<span style="color:#ccc">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</span>';
            btn.style.display = 'none';
            currentTokens = [];
            return;
        }

        currentTokens = tokenize(text);
        let html = '';
        currentTokens.forEach(t => {
            if(allWords.has(t)) html += `<span class="token">${t}</span>`;
            else html += `<span class="token unknown" onclick="quickAdd('${t}')">${t}</span>`;
        });
        out.innerHTML = html;
        btn.style.display = 'inline-block';
    }

    function tokenize(text) {
        let res = [];
        let cursor = 0;
        const len = text.length;
        while(cursor < len) {
            let found = null;
            let max = 40;
            for(let i=max; i>0; i--) {
                if(cursor+i > len) continue;
                let sub = text.substr(cursor, i);
                if(allWords.has(sub)) { found = sub; break; }
            }
            if(found) { res.push(found); cursor += found.length; }
            else { res.push(text[cursor]); cursor++; }
        }
        return res;
    }

    function quickAdd(word) {
        document.getElementById('newWordInput').value = word;
        document.getElementById('searchInput').value = word;
        checkWord(); // update status
        document.getElementById('newWordInput').focus();
    }

    function saveResultText() {
        if(currentTokens.length) downloadFile("result.txt", currentTokens.join(" "), "text/plain");
    }

    function downloadFile(name, content, type) {
        const a = document.createElement("a");
        const blob = new Blob([content], {type: type});
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
    }

    function handleEnter(e) { if(e.key === 'Enter') addNewWord(); }
    function resetDictionary() {
        if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
            userWords.clear();
            localStorage.removeItem('thaiDictPWA_v8');
            refreshAllWords();
            renderUserTags();
            processText();
        }
    }

    // Start
    init();

</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

</body>
</html>