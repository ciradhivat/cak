<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gamified Review — Mobile Enhanced (Pro)</title>
  <style>
    /* Clean, professional responsive UI */
    :root{
      --bg: #eef2f7;
      --card: #ffffff;
      --muted: #64748b;
      --accent: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --radius: 12px;
    }

    html,body{height:100%;}
    body{
      margin:0; padding:20px; font-family: Inter, 'Segoe UI', Roboto, Arial, sans-serif; background:var(--bg); color:#0f172a;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;flex-direction:column;gap:10px;margin-bottom:18px}
    header .title{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}

    .grid{display:block;gap:12px}
    @media(min-width:760px){.grid{display:grid;grid-template-columns:1fr 320px}}

    .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(14,24,41,0.06)}

    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=file], input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid #d7e0ea}

    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .controls button{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #e6edf8;color:#123}

    .stats{display:flex;flex-wrap:wrap;gap:8px}
    .badge{background:#fff;padding:8px 10px;border-radius:999px;border:1px solid #e6edf8;font-size:13px;color:var(--muted)}

    .term{font-size:22px;font-weight:700;margin:6px 0}
    .def{font-size:16px;color:#334155;margin-bottom:10px}

    .choices button{display:block;width:100%;text-align:left;padding:12px;border-radius:8px;border:1px solid #e9eef6;margin-bottom:8px;background:#fff}

    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

    /* small helpers */
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Gamified Review — Professional</h1>
        <div class="sub">Local-only • บันทึกในเครื่อง</div>
      </div>
      <div class="muted">อัปโหลดไฟล์คำศัพท์ (.txt) ที่มีรูปแบบบรรทัดเริ่มต้นด้วย "*" และคั่นคำกับความหมายด้วย "="</div>
    </header>

    <main class="grid">
      <section>
        <div class="card">
          <label for="file">อัปโหลดไฟล์ .txt</label>
          <input id="file" type="file" accept="text/plain" />
          <div class="controls" style="margin-top:10px">
            <button id="parseBtn" class="btn-primary">แปลงคำศัพท์</button>
            <button id="loadDemo" class="btn-ghost">โหลดตัวอย่าง</button>
            <button id="resetBtn" class="btn-danger">รีเซ็ต</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="stats">
            <div class="badge">คำศัพท์ <strong id="total">0</strong></div>
            <div class="badge">ถึงเวลา <strong id="due">0</strong></div>
            <div class="badge">คะแนน <strong id="score">0</strong></div>
            <div class="badge">สตรีค <strong id="streak">0</strong></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="flashBtn" class="btn-primary">เริ่ม Flashcards</button>
            <button id="quizBtn" class="btn-ghost">เริ่ม Quiz</button>
            <button id="exportBtn" class="btn-ghost">Export</button>
            <input id="importFile" type="file" accept=".json" style="display:inline-block;width:auto">
          </div>
        </div>

        <div id="mainArea" class="card" style="margin-top:12px">
          <div id="browseArea">
            <div class="muted">ตัวอย่างคำศัพท์ (แสดง 200 รายการแรก)</div>
            <div id="list" style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:8px;max-height:300px;overflow:auto"></div>
          </div>

          <div id="flashArea" style="display:none">
            <div class="muted">Flashcard</div>
            <div class="term" id="term">-</div>
            <div class="def" id="def">(ซ่อน)</div>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <button id="showAns" class="btn-ghost">เปิดคำตอบ</button>
              <button id="remember" class="btn-success">จำได้</button>
              <button id="forget" class="btn-danger">ไม่จำได้</button>
              <button id="nextCard" class="btn-ghost">ถัดไป</button>
            </div>
            <div class="muted" id="srsInfo" style="margin-top:8px">reps=0 ef=2.50 interval=1 วัน</div>
          </div>

          <div id="quizArea" style="display:none">
            <div class="muted">Quiz</div>
            <div class="def" id="qDef" style="margin-top:8px">-</div>
            <div id="choices" class="choices" style="margin-top:12px"></div>
          </div>
        </div>
      </section>

      <aside>
        <div class="card">
          <div class="muted">Badges</div>
          <div id="badges" style="margin-top:8px">ยังไม่มี</div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="muted">Leaderboard (local)</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="saveScore" class="btn-ghost">บันทึกคะแนน</button>
            <button id="showTop" class="btn-ghost">ดู Top</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="muted">การตั้งค่า SRS</div>
          <label class="muted" style="margin-top:8px">เริ่ม EF</label>
          <input id="startEF" type="number" value="2.5" step="0.1" />
        </div>
      </aside>
    </main>

    <footer>
      <div>หมายเหตุ: โปรโตไทป์นี้ออกแบบให้ใช้งานแบบ local — ปรับแต่งเพิ่มเติมได้ตามต้องการ</div>
    </footer>
  </div>

  <script>
    // Core data
    let items = [];
    let currentIndex = 0;
    let score = 0;
    let streak = 0;

    console.log('[INIT] Pro app initialized');

    // Load state from localStorage
    function loadState(){
      try{
        const raw = localStorage.getItem('g_items_v1');
        if(raw) items = JSON.parse(raw);
      }catch(e){ console.warn('[STATE] Failed to load items', e); }
      score = Number(localStorage.getItem('g_score_v1')||0);
      streak = Number(localStorage.getItem('g_streak_v1')||0);
      renderStats(); renderList(); renderBadges();
    }
    loadState();

    function saveState(){
      try{ localStorage.setItem('g_items_v1', JSON.stringify(items)); }catch(e){console.warn('[STATE] Save failed',e)}
      localStorage.setItem('g_score_v1', String(score));
      localStorage.setItem('g_streak_v1', String(streak));
    }

    // Parser (robust for typical formats)
    function parseContent(text){
      const lines = text.split(/\r?\n/);
      const out = [];
      let id=1; let currentCat='ทั่วไป';
      for(const raw of lines){
        const l = raw.trim();
        if(!l) continue;
        // detect category header like '1. หมวด...'
        const catMatch = l.match(/^\d+\.\s+หมวด/);
        if(catMatch){ currentCat = l.replace(/^\d+\.\s+/,''); continue; }
        const m = l.match(/^[\*\-•]\s*(.+)/);
        if(m){
          let body = m[1].trim();
          // split by '=' if present
          let term='', def='';
          if(body.includes('=')){
            const parts = body.split('=');
            term = parts[0].trim();
            def = parts.slice(1).join('=').trim();
          } else {
            // fallback: try to find ' = ' with parentheses
            const paren = body.match(/^(.*?)\s*\((.*?)\)\s*=\s*(.+)$/);
            if(paren){ term = paren[1].trim() + ' ('+paren[2].trim()+')'; def = paren[3].trim(); }
            else {
              const dash = body.match(/^(.*?)\s+[-–—:]\s*(.+)$/);
              if(dash){ term = dash[1].trim(); def = dash[2].trim(); }
              else { // as last resort, split by tab
                const parts = body.split('\t'); term = parts[0].trim(); def = (parts[1]||'').trim();
              }
            }
          }
          out.push({id:id++, term, def, category: currentCat, ef:2.5, interval:1, next:Date.now(), reps:0, correct:0});
        }
      }
      return out;
    }

    // UI helpers
    function renderList(){
      const el = document.getElementById('list'); el.innerHTML='';
      items.slice(0,200).forEach(it=>{
        const d = document.createElement('div'); d.className='card'; d.style.padding='10px'; d.innerHTML = `<div style="font-weight:700">${escapeHtml(it.term)}</div><div style="color:#475569;margin-top:6px">${escapeHtml(it.def)}</div><div style="font-size:12px;color:#94a3b8;margin-top:8px">${escapeHtml(it.category)}</div>`;
        el.appendChild(d);
      });
      document.getElementById('total').textContent = items.length;
      document.getElementById('due').textContent = items.filter(i=>i.next<=Date.now()).length;
    }

    function renderStats(){
      document.getElementById('score').textContent = score;
      document.getElementById('streak').textContent = streak;
    }

    function renderBadges(){
      const el = document.getElementById('badges'); el.innerHTML='';
      const set = new Set();
      if(score>=100) set.add('Bronze: 100 pts');
      if(score>=300) set.add('Silver: 300 pts');
      if(score>=700) set.add('Gold: 700 pts');
      if(streak>=7) set.add('7-day streak');
      if(set.size===0) el.textContent='ยังไม่มี'; else set.forEach(s=>{ const b=document.createElement('div'); b.className='badge'; b.textContent=s; el.appendChild(b); });
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // File handlers
    document.getElementById('parseBtn').addEventListener('click', ()=>{
      console.log('[EVENT] Parse requested');
      const f = document.getElementById('file').files[0];
      if(!f) return alert('เลือกไฟล์ก่อน');
      const r = new FileReader(); r.onload = ev=>{
        console.log('[FILE] loaded, size:', f.size);
        const parsed = parseContent(ev.target.result);
        console.log('[PARSE] result count:', parsed.length);
        items = parsed; saveState(); renderList(); renderStats(); renderBadges(); alert('แปลงเรียบร้อย');
      };
      r.readAsText(f,'utf-8');
    });

    document.getElementById('loadDemo').addEventListener('click', ()=>{
      const demo = `รวมคำศัพท์ภาษาผัก (Bhasa Phak Glossary)\n1. หมวดสรรพนาม (Pronouns) - 5 คำ\n * Aha (อะหะ) = ฉัน\n * Tava (ตะวะ) = เธอ\n * So (โส) = เขา\n2. หมวดคำกริยา (Verbs) - 6 คำ\n * Harati (หะระติ) = นำ/พา\n * Karati (กะระติ) = ทำ\n * Gacchati (คัจฉะติ) = ไป\n * Passati (ปัสสะติ) = เห็น\n * Pivati (ปิวะติ) = ดื่ม\n * Vadati (วะทะติ) = พูด\n`;
      items = parseContent(demo); saveState(); renderList(); renderStats(); renderBadges(); alert('โหลดตัวอย่างเรียบร้อย');
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(!confirm('รีเซ็ตความคืบหน้าทั้งหมด?')) return; localStorage.clear(); items=[]; score=0; streak=0; saveState(); renderList(); renderStats(); renderBadges(); alert('รีเซ็ตเรียบร้อย');
    });

    // Flashcards (SRS simplified)
    document.getElementById('flashBtn').addEventListener('click', ()=>{
      if(!items.length) return alert('ยังไม่มีคำศัพท์'); currentIndex = 0; showFlash(); document.getElementById('flashArea').style.display='block'; document.getElementById('quizArea').style.display='none';
    });

    function showFlash(){
      const it = items[currentIndex];
      console.log('[FLASH] show index', currentIndex, it);
      document.getElementById('term').textContent = it.term || '-';
      document.getElementById('def').textContent = '(ซ่อน)';
      document.getElementById('srsInfo').textContent = `reps=${it.reps||0} ef=${(it.ef||2.5).toFixed(2)} interval=${it.interval||1} วัน`;
    }

    document.getElementById('showAns').addEventListener('click', ()=>{ console.log('[FLASH] reveal'); document.getElementById('def').textContent = items[currentIndex].def || '(ไม่มี)'; });
    document.getElementById('remember').addEventListener('click', ()=>{ answerFlash(true); });
    document.getElementById('forget').addEventListener('click', ()=>{ answerFlash(false); });
    document.getElementById('nextCard').addEventListener('click', ()=>{ nextFlash(); });

    function answerFlash(correct){
      const it = items[currentIndex]; const now = Date.now();
      if(correct){ it.correct=(it.correct||0)+1; it.reps=(it.reps||0)+1; it.ef = Math.max(1.3,(it.ef||2.5)+0.1); it.interval = Math.round((it.interval||1)*it.ef)||1; it.next = now + it.interval*24*3600*1000; score+=10; streak+=1; }
      else { it.reps=0; it.ef=Math.max(1.3,(it.ef||2.5)-0.3); it.interval=1; it.next = now + 0.5*24*3600*1000; streak=0; }
      saveState(); renderStats(); renderBadges();
      alert(correct? 'บันทึก: จำได้' : 'บันทึก: ไม่จำได้');
      nextFlash();
    }

    function nextFlash(){ currentIndex++; if(currentIndex>=items.length){ alert('จบแล้ว'); document.getElementById('flashArea').style.display='none'; return;} showFlash(); }

    // Quiz
    document.getElementById('quizBtn').addEventListener('click', ()=>{
      if(!items.length) return alert('ยังไม่มีคำศัพท์'); currentIndex=0; showQuiz(); document.getElementById('quizArea').style.display='block'; document.getElementById('flashArea').style.display='none';
    });

    function showQuiz(){
      const it = items[currentIndex];
      document.getElementById('qDef').textContent = it.def || '(ไม่มี)';
      const choices = shuffle([it.term, ...randomOthers(it.term)]);
      const cont = document.getElementById('choices'); cont.innerHTML='';
      choices.forEach(choice=>{
        const btn = document.createElement('button'); btn.textContent = choice; btn.style.marginTop='8px';
        btn.onclick = ()=>{ if(choice===it.term){ score+=15; alert('ถูกต้อง'); } else { alert('ผิด'); } saveState(); renderStats(); renderBadges(); currentIndex++; if(currentIndex>=items.length){ alert('Quiz จบแล้ว'); document.getElementById('quizArea').style.display='none'; return; } showQuiz(); };
        cont.appendChild(btn);
      });
    }

    function randomOthers(correct){ const pool = items.filter(i=>i.term!==correct); return shuffle(pool).slice(0,3).map(i=>i.term); }

    // Export / Import / Leaderboard
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const payload={items,score,streak}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='review-progress.json'; a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('importFile').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ const p=JSON.parse(ev.target.result); if(p.items) items=p.items; score=Number(p.score||0); streak=Number(p.streak||0); saveState(); renderList(); renderStats(); renderBadges(); alert('นำเข้าเรียบร้อย'); }catch(err){ alert('ไฟล์ไม่ถูกต้อง') } }; r.readAsText(f,'utf-8'); });

    document.getElementById('saveScore').addEventListener('click', ()=>{ const board=JSON.parse(localStorage.getItem('g_leader_v1')||'[]'); const entry={username: 'local', score, at:Date.now()}; board.push(entry); board.sort((a,b)=>b.score-a.score); localStorage.setItem('g_leader_v1', JSON.stringify(board.slice(0,20))); alert('บันทึกคะแนนเรียบร้อย'); });
    document.getElementById('showTop').addEventListener('click', ()=>{ const b=JSON.parse(localStorage.getItem('g_leader_v1')||'[]'); alert(JSON.stringify(b.slice(0,10),null,2)); });

    // Utilities
    function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  </script>
</body>
</html>
